name: CI - Tests & Quality Checks

on:
  pull_request:
    branches: [development, main, master]
  push:
    branches: [development, main, master]

jobs:
  tests:
    name: PHP ${{ matrix.php-version }} Tests with Nextcloud
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Load version configuration
        run: |
          echo "Loading centralized version configuration..."
          if [ -f .github/workflows/versions.env ]; then
            echo "‚úÖ Found versions.env file"
            cat .github/workflows/versions.env
            # Export variables for use in subsequent steps
            echo "NEXTCLOUD_VERSION=31" >> $GITHUB_ENV
            echo "MARIADB_VERSION=10.6" >> $GITHUB_ENV
            echo "REDIS_VERSION=7" >> $GITHUB_ENV
            echo "MAILHOG_VERSION=latest" >> $GITHUB_ENV
            echo "NEXTCLOUD_IMAGE=nextcloud:31" >> $GITHUB_ENV
            echo "MARIADB_IMAGE=mariadb:10.6" >> $GITHUB_ENV
            echo "REDIS_IMAGE=redis:7" >> $GITHUB_ENV
            echo "MAILHOG_IMAGE=ghcr.io/juliusknorr/nextcloud-dev-mailhog:latest" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No versions.env found, using defaults"
            echo "NEXTCLOUD_VERSION=31" >> $GITHUB_ENV
            echo "MARIADB_VERSION=10.6" >> $GITHUB_ENV
            echo "REDIS_VERSION=7" >> $GITHUB_ENV
            echo "MAILHOG_VERSION=latest" >> $GITHUB_ENV
            echo "NEXTCLOUD_IMAGE=nextcloud:31" >> $GITHUB_ENV
            echo "MARIADB_IMAGE=mariadb:10.6" >> $GITHUB_ENV
            echo "REDIS_IMAGE=redis:7" >> $GITHUB_ENV
            echo "MAILHOG_IMAGE=ghcr.io/juliusknorr/nextcloud-dev-mailhog:latest" >> $GITHUB_ENV
          fi
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, pdo, zip, curl, mysql
          tools: composer:v2
          
      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
        
      - name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      - name: Install dependencies on GitHub Actions runner
        run: |
          # Update dependencies to ensure lock file is current
          composer update --no-interaction --prefer-dist
          
          # Verify PHPUnit is available
          if [ ! -f "./vendor/bin/phpunit" ]; then
            echo "PHPUnit not found, installing directly..."
            composer require --dev phpunit/phpunit:^9.6 --no-interaction
          fi
          
          # Verify PHPUnit works
          ./vendor/bin/phpunit --version
        
      - name: Start MariaDB, Redis, Mail and Nextcloud with Docker
        run: |
          # Start MariaDB container (matching local setup)
          docker run -d \
            --name mariadb-test \
            -e MYSQL_ROOT_PASSWORD=nextcloud \
            -e MYSQL_PASSWORD=nextcloud \
            -e MYSQL_USER=nextcloud \
            -e MYSQL_DATABASE=nextcloud \
            ${{ env.MARIADB_IMAGE }}
          
          # Start Redis container (required by Nextcloud)
          docker run -d \
            --name redis-test \
            ${{ env.REDIS_IMAGE }}
          
          # Start Mail container (MailHog for testing) - matching local setup
          docker run -d \
            --name mail-test \
            -p 1025:1025 \
            -p 8025:8025 \
            ${{ env.MAILHOG_IMAGE }}
          
          # Wait for MariaDB to be ready
          echo "Waiting for MariaDB to start..."
          timeout 60 bash -c 'until docker exec mariadb-test mysqladmin ping -h"localhost" --silent; do sleep 2; done'
          
          # Start Nextcloud container with all dependencies - matching local setup
          docker run -d \
            --name nextcloud-test \
            --link mariadb-test:db \
            --link redis-test:redis \
            --link mail-test:mail \
            -p 8080:80 \
            -e MYSQL_HOST=db \
            -e MYSQL_DATABASE=nextcloud \
            -e MYSQL_USER=nextcloud \
            -e MYSQL_PASSWORD=nextcloud \
            -e REDIS_HOST=redis \
            -e REDIS_PORT=6379 \
            -e MAIL_SMTP_HOST=mail \
            -e MAIL_SMTP_PORT=1025 \
            -e MAIL_SMTP_NAME=mail \
            -e MAIL_SMTP_PASSWORD= \
            -e MAIL_SMTP_SECURE= \
            -e MAIL_FROM_ADDRESS=nextcloud@localhost \
            -e MAIL_DOMAIN=localhost \
            -e NEXTCLOUD_ADMIN_USER=admin \
            -e NEXTCLOUD_ADMIN_PASSWORD=admin \
            -e NEXTCLOUD_TRUSTED_DOMAINS=localhost \
            -e WITH_REDIS=YES \
            ${{ env.NEXTCLOUD_IMAGE }}
          
          # Wait for Nextcloud to be fully ready (including database initialization)
          echo "Waiting for Nextcloud to be fully initialized..."
          timeout 600 bash -c 'until curl -sSf http://localhost:8080/status.php | grep -q "installed.*true"; do echo "Waiting for Nextcloud to start..."; sleep 10; done'
          echo "Nextcloud is fully initialized and ready!"
          
          # Create apps-extra directory in Nextcloud container
          echo "Creating apps-extra directory in Nextcloud container..."
          docker exec nextcloud-test mkdir -p /var/www/html/apps-extra
          
          # Copy the OpenConnector app into the container
          echo "Copying OpenConnector app into Nextcloud container..."
          docker cp . nextcloud-test:/var/www/html/apps-extra/openconnector
          
          # Wait a bit more for Nextcloud to fully process the app installation
          echo "Waiting for app installation to complete..."
          sleep 10
          
      - name: Diagnose Nextcloud occ command availability
        run: |
          echo "=== Nextcloud occ Command Diagnostics ==="
          echo "Checking if occ command is available..."
          
          # Check if occ file exists
          if ! docker exec nextcloud-test bash -c "test -f /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file not found at /var/www/html/occ"
            echo "This indicates Nextcloud is not properly installed"
            exit 1
          fi
          echo "‚úÖ occ file exists at /var/www/html/occ"
          
          # Check if occ is executable
          if ! docker exec nextcloud-test bash -c "test -x /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file is not executable"
            echo "This indicates Nextcloud installation is incomplete"
            exit 1
          fi
          echo "‚úÖ occ file is executable"
          
          # Test if occ command works
          if ! docker exec nextcloud-test bash -c "cd /var/www/html && php occ --version"; then
            echo "‚ùå ERROR: occ command failed to run"
            echo "This indicates Nextcloud is not fully initialized or has configuration issues"
            exit 1
          fi
          echo "‚úÖ occ command is working"
          
          echo "Checking Nextcloud installation..."
          if ! docker exec nextcloud-test bash -c "ls -la /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file not found at /var/www/html/occ"
            echo "This indicates Nextcloud is not properly installed"
            exit 1
          fi
          echo "‚úÖ occ file found"
          
          echo "Checking if Nextcloud is fully initialized..."
          if ! docker exec nextcloud-test bash -c "php -r 'echo \"PHP is working\n\";'"; then
            echo "‚ùå ERROR: PHP is not working in the container"
            exit 1
          fi
          echo "‚úÖ PHP is working"
          echo "=== End occ Command Diagnostics ==="
          
      - name: Install Composer in Nextcloud container
        run: |
          echo "=== Installing Composer in Nextcloud Container ==="
          echo "Installing Composer..."
          docker exec nextcloud-test bash -c "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
          echo "Verifying Composer installation..."
          if ! docker exec nextcloud-test bash -c "composer --version"; then
            echo "‚ùå ERROR: Composer installation failed"
            exit 1
          fi
          echo "‚úÖ Composer installed successfully"
          
      - name: Install and enable OpenConnector app
        run: |
          echo "=== OpenConnector App Installation ==="
          echo "Checking Nextcloud version compatibility..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ --version"
          
          # Check if app directory exists
          echo "Checking if OpenConnector app directory exists..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps-extra/openconnector/"
          
          # List available apps
          echo "Listing available apps..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list"
          
          # Move app to correct location for Nextcloud
          echo "Moving app to correct location for Nextcloud..."
          docker exec nextcloud-test bash -c "cp -r /var/www/html/apps-extra/openconnector /var/www/html/apps/"
          echo "App moved to /var/www/html/apps/openconnector"
          
          # Install app dependencies BEFORE enabling the app
          echo "Installing app dependencies before enabling..."
          docker exec nextcloud-test bash -c "cd /var/www/html/apps/openconnector && composer install --no-dev --optimize-autoloader --ignore-platform-req=ext-soap --ignore-platform-req=ext-xsl"
          echo "‚úÖ App dependencies installed successfully"
          
          # Run maintenance:repair to ensure database schema is ready
          echo "Running maintenance:repair to prepare database schema..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Database schema prepared"
          
          # Test available Nextcloud commands for database preparation (v1.35)
          echo "=== Testing Available Nextcloud Commands ==="
          echo "üîç DIAGNOSTIC: Testing app --help command with enhanced diagnostics..."
          
          # Wait for Nextcloud to be fully ready
          echo "üîÑ Waiting for Nextcloud to be fully ready..."
          sleep 15
          
          # Check if Nextcloud is responding to basic commands first
          echo "üîÑ Testing basic Nextcloud functionality..."
          if timeout 30 docker exec nextcloud-test bash -c "cd /var/www/html && php occ --version" 2>/dev/null; then
            echo "‚úÖ Nextcloud basic commands working"
          else
            echo "‚ö†Ô∏è  WARNING: Nextcloud basic commands test failed or timed out"
            echo "This might indicate Nextcloud is still initializing, but we'll continue..."
            echo "Checking if we can proceed anyway..."
            
            # Try a simpler test
            if docker exec nextcloud-test bash -c "cd /var/www/html && php -r 'echo \"PHP working\n\";'" 2>/dev/null; then
              echo "‚úÖ PHP is working, continuing with app installation..."
            else
              echo "‚ùå ERROR: PHP is not working in the container"
              echo "Checking container status..."
              docker exec nextcloud-test bash -c "ps aux | grep php"
              echo "Checking Nextcloud logs..."
              docker exec nextcloud-test bash -c "tail -20 /var/www/html/data/nextcloud.log"
              exit 1
            fi
          fi
          
          # Check what app commands are available (with timeout)
          echo "üîÑ Checking available app commands..."
          if timeout 30 docker exec nextcloud-test bash -c "cd /var/www/html && php occ app --help" 2>/dev/null; then
            echo "‚úÖ App commands are working"
          else
            echo "‚ö†Ô∏è  WARNING: app --help command failed or timed out"
            echo "Trying alternative approach..."
            echo "üîÑ Checking app commands with verbose output..."
            if timeout 30 docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list" 2>/dev/null; then
              echo "‚úÖ app:list is working, continuing..."
            else
              echo "‚ö†Ô∏è  app:list also failed, trying basic occ list..."
              if timeout 30 docker exec nextcloud-test bash -c "cd /var/www/html && php occ list" 2>/dev/null; then
                echo "‚úÖ Basic occ commands are working, continuing..."
              else
                echo "‚ùå All occ commands are failing - this indicates a serious Nextcloud issue"
                exit 1
              fi
            fi
          fi
          
          # Try to install the app directly (this should trigger migrations)
          echo "üîÑ Testing: Direct app install (should trigger migrations)..."
          if docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:install openconnector"; then
            echo "‚úÖ SUCCESS: App installed successfully with migrations"
            MIGRATION_SUCCESS=true
          else
            echo "‚ùå FAILED: Direct app install failed"
            MIGRATION_SUCCESS=false
          fi
          
          # If direct install failed, try alternative approach
          if [ "$MIGRATION_SUCCESS" = false ]; then
            echo "üîÑ Fallback: Trying app:enable..."
            if docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:enable openconnector"; then
              echo "‚úÖ SUCCESS: App enabled successfully"
              MIGRATION_SUCCESS=true
            else
              echo "‚ùå FAILED: App enable also failed"
              MIGRATION_SUCCESS=false
            fi
          fi
          
          # Final fallback: try app:update
          if [ "$MIGRATION_SUCCESS" = false ]; then
            echo "üîÑ Final fallback: Trying app:update..."
            if docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:update openconnector"; then
              echo "‚úÖ SUCCESS: App updated successfully"
              MIGRATION_SUCCESS=true
            else
              echo "‚ùå FAILED: App update also failed"
              MIGRATION_SUCCESS=false
            fi
          fi
          
          # Summary of results
          echo "=== Migration Test Results ==="
          echo "Migration preparation: $MIGRATION_SUCCESS"
          
          # Check if app is already enabled from migration testing
          if [ "$MIGRATION_SUCCESS" = true ]; then
            echo "‚úÖ App already enabled during migration testing"
          else
            echo "‚ùå ERROR: All migration approaches failed"
            echo "Checking app status..."
            docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list | grep openconnector"
            echo "Checking Nextcloud logs..."
            docker exec nextcloud-test bash -c "tail -50 /var/www/html/data/nextcloud.log"
            echo "Checking if database table exists..."
            docker exec mariadb-test bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES LIKE \"oc_openconnector_job_logs\";'"
            echo "Checking database connection..."
            docker exec mariadb-test bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SELECT COUNT(*) FROM oc_openconnector_job_logs;'"
            exit 1
          fi
          echo "‚úÖ OpenConnector app enabled successfully"
          
          # Run database migrations for the app
          echo "Running database migrations for OpenConnector app..."
          echo "üîÑ Running db:add-missing-indices..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ db:add-missing-indices"
          echo "üîÑ Running db:add-missing-columns..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ db:add-missing-columns"
          echo "üîÑ Running db:convert-filecache-bigint..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ db:convert-filecache-bigint"
          
          # Force app migration execution by disabling and re-enabling the app
          echo "üîÑ Forcing app migration execution..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:disable openconnector"
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ Database migrations completed"
          
          # Verify the required table exists after migrations
          echo "üîÑ Verifying database table exists after migrations..."
          echo "üîç DIAGNOSTIC: Testing MariaDB connection from mariadb-test container..."
          if docker exec mariadb-test bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SELECT COUNT(*) FROM oc_openconnector_job_logs;'" 2>/dev/null; then
            echo "‚úÖ Table oc_openconnector_job_logs exists"
            echo "üéâ SUCCESS: Database verification with MariaDB container connection works!"
          else
            echo "‚ùå Table oc_openconnector_job_logs still doesn't exist after migrations"
            echo "üîç DIAGNOSTIC: Checking what tables actually exist..."
            docker exec mariadb-test bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES LIKE \"oc_openconnector%\";'"
            echo "üîç DIAGNOSTIC: Checking all tables in nextcloud database..."
            docker exec mariadb-test bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES;'" | grep -i openconnector || echo "No openconnector tables found"
            echo "This indicates the app's migration files are not being executed properly"
            exit 1
          fi
          
          # Verify app is properly enabled
          echo "Verifying app installation..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list | grep openconnector"
          
          # Check if app classes are available (before dependencies)
          echo "Checking if app classes are available (before dependencies)..."
          echo "‚ö†Ô∏è  NOTE: This is expected to fail before dependencies are installed"
          docker exec nextcloud-test bash -c "cd /var/www/html && php -r 'echo \"Testing class loading...\n\"; if (class_exists(\"OCA\\\\OpenConnector\\\\AppInfo\\\\Application\")) { echo \"‚úÖ OpenConnector Application class found (unexpected but good!)\n\"; } else { echo \"‚ö†Ô∏è  OpenConnector Application class not found (expected before dependencies)\n\"; }'"
          
          # Set up test environment
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ config:system:set debug --value true"
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ config:system:set loglevel --value 0"
          
          # Wait a bit more for Nextcloud to fully process the app installation
          echo "Waiting for app installation to complete..."
          sleep 10
          
      - name: Verify app installation and run diagnostics
        run: |
          echo "=== App Installation Verification and Diagnostics ==="
          echo "Verifying app dependencies are present..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/vendor/autoload.php || echo 'Autoloader not found'"
          
          # Check app structure and files
          echo "Checking app structure and files..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps-extra/openconnector/"
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps-extra/openconnector/appinfo/"
          docker exec nextcloud-test bash -c "cat /var/www/html/apps-extra/openconnector/appinfo/info.xml | head -10"
          
          # Check if app is in the right location for Nextcloud
          echo "Checking if app is in correct location..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/ 2>/dev/null | grep openconnector || echo 'No openconnector found in /var/www/html/apps/'"
          
          echo "‚úÖ App should already be in /var/www/html/apps/ from previous step"
          
          # Force Nextcloud to rescan apps and clear caches
          echo "Forcing Nextcloud to rescan apps and clear caches..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list"
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ maintenance:repair"
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list"
          
          # Check if app classes are available after dependencies
          echo "Checking if app classes are available (after dependencies)..."
          echo "üéØ This should now work after installing dependencies"
          
          # Pre-class loading diagnostics
          echo "=== Pre-Class Loading Diagnostics ==="
          echo "Checking app installation status..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list | grep openconnector || echo 'App not found in Nextcloud app list'"
          
          echo "Checking app file structure..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/ || echo 'App directory not found'"
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/ || echo 'Lib directory not found'"
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/vendor/ || echo 'Vendor directory not found'"
          
          echo "Checking app info.xml..."
          docker exec nextcloud-test bash -c "cat /var/www/html/apps/openconnector/appinfo/info.xml | head -10"
          
          echo "Checking if Application.php exists..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/AppInfo/Application.php || echo 'Application.php not found'"
          
          echo "Checking autoloader files..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/vendor/autoload.php || echo 'Vendor autoload.php not found'"
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php || echo 'App autoload.php not found'"
          
          # Check if autoloader was already generated during app installation
          echo "üîç DIAGNOSTIC: Checking if autoloader was generated during initial app installation..."
          if docker exec nextcloud-test bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php already exists from app installation!"
            echo "‚úÖ No additional autoloader generation needed"
            exit 0
          else
            echo "‚ùå lib/autoload.php not found after app installation - proceeding with generation..."
          fi
          
          # v1.43: Comprehensive autoloader generation strategy
          echo "üîß ATTEMPTING: Comprehensive autoloader generation strategy (v1.43)..."
          
          # Step 1: Force app disable/enable cycle to trigger autoloader generation
          echo "üîÑ Step 1: Force app disable/enable cycle to trigger autoloader generation..."
          echo "üîç DIAGNOSTIC: Disabling app to force regeneration..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:disable openconnector" || echo "App disable failed or app not enabled"
          echo "üîç DIAGNOSTIC: Re-enabling app to trigger autoloader generation..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ App disable/enable cycle completed"
          
          # Step 2: Force maintenance repair to regenerate autoloaders
          echo "üîÑ Step 2: Force maintenance repair to regenerate autoloaders..."
          echo "üîç DIAGNOSTIC: Running maintenance:repair to regenerate autoloaders..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Maintenance repair completed"
          
          # Step 3: Force app update with --force flag
          echo "üîÑ Step 3: Force app update with --force flag..."
          echo "üîç DIAGNOSTIC: Running app:update with force flag..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:update openconnector --force" || echo "Force update not supported, trying regular update..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:update openconnector"
          echo "‚úÖ App update completed"
          
          # Step 4: Generate autoloader manually using Composer
          echo "üîÑ Step 4: Generate autoloader manually using Composer..."
          echo "üîç DIAGNOSTIC: Running composer dump-autoload with classmap optimization..."
          docker exec nextcloud-test bash -c "cd /var/www/html/apps/openconnector && composer dump-autoload --optimize --classmap-authoritative"
          echo "‚úÖ Composer autoloader generation completed"
          
          # Step 5: Create lib/autoload.php manually if still missing
          echo "üîÑ Step 5: Create lib/autoload.php manually if still missing..."
          echo "üîç DIAGNOSTIC: Checking if lib/autoload.php exists after all attempts..."
          if docker exec nextcloud-test bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php exists after comprehensive generation!"
          else
            echo "üîß ATTEMPTING: Creating lib/autoload.php manually..."
            docker exec nextcloud-test bash -c "cd /var/www/html/apps/openconnector && cat > lib/autoload.php << 'EOF'
<?php
// Nextcloud app autoloader for OpenConnector
// Generated by v1.43 comprehensive autoloader generation

// Include Composer autoloader
require_once __DIR__ . '/../vendor/autoload.php';

// Register PSR-4 autoloader for OCA\\OpenConnector namespace
spl_autoload_register(function (\$class) {
    // Handle OCA\\OpenConnector namespace
    if (strpos(\$class, 'OCA\\\\OpenConnector\\\\') === 0) {
        \$class = substr(\$class, 19); // Remove 'OCA\\\\OpenConnector\\\\'
        \$file = __DIR__ . '/' . str_replace('\\\\', '/', \$class) . '.php';
        if (file_exists(\$file)) {
            require_once \$file;
        }
    }
});
EOF"
            echo "‚úÖ Manual lib/autoload.php created"
          fi

          # Final verification
          echo "üîç DIAGNOSTIC: Final verification of autoloader..."
          if docker exec nextcloud-test bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php verified after comprehensive generation!"
            echo "üîç DIAGNOSTIC: Checking autoloader file size and permissions..."
            docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php"
          else
            echo "‚ùå ERROR: lib/autoload.php still not found after comprehensive generation"
            echo "üîç DIAGNOSTIC: Checking what was generated in container..."
            docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/ || echo 'lib directory not found'"
            echo "üîç DIAGNOSTIC: Checking composer.json for autoload configuration..."
            docker exec nextcloud-test bash -c "cat /var/www/html/apps/openconnector/composer.json | grep -A 10 -B 5 autoload || echo 'No autoload section found'"
            echo "üîç DIAGNOSTIC: Checking if lib directory exists..."
            docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/ | grep lib"
            echo "üîç DIAGNOSTIC: Checking where Composer actually placed autoload files..."
            docker exec nextcloud-test bash -c "find /var/www/html/apps/openconnector -name 'autoload.php' -type f"
            echo "üîç DIAGNOSTIC: Checking vendor directory for autoload files..."
            docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/vendor/ | grep autoload"
            echo "üîç DIAGNOSTIC: Checking if Composer created any autoload files in lib directory..."
            docker exec nextcloud-test bash -c "find /var/www/html/apps/openconnector/lib -name '*autoload*' -type f"
            echo "üîç DIAGNOSTIC: Checking Composer working directory and current location..."
            docker exec nextcloud-test bash -c "cd /var/www/html/apps/openconnector && pwd && ls -la"
            exit 1
          fi
          
          # Restart Nextcloud to reload the new autoloader
          echo "Restarting Nextcloud to reload autoloader..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:disable openconnector"
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ Nextcloud restarted with new autoloader"
          
          # Verify autoloader was created and clear cache
          echo "Verifying autoloader creation..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php || echo 'Autoloader still missing'"
          echo "Clearing Nextcloud cache..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Cache cleared after autoloader generation"
          
          # Wait for Nextcloud background processes to complete
          # maintenance:repair triggers background jobs (cache clearing, database migrations, etc.)
          # These processes need time to complete before classes become available
          echo "Waiting for Nextcloud background processes to complete..."
          
          # Try class loading with retry mechanism
          echo "Testing class loading with retry mechanism..."
          for i in {1..5}; do
            echo "Attempt $i/5:"
            if docker exec nextcloud-test bash -c "cd /var/www/html && php -r 'echo \"Testing class loading...\n\"; if (class_exists(\"OCA\\\\OpenConnector\\\\AppInfo\\\\Application\")) { echo \"‚úÖ OpenConnector Application class found (SUCCESS!)\n\"; exit(0); } else { echo \"‚ùå OpenConnector Application class not found (attempt $i)\n\"; exit(1); }'"; then
              echo "‚úÖ Class loading successful on attempt $i"
              break
            else
              if [ $i -lt 5 ]; then
                echo "‚ö†Ô∏è Attempt $i failed, waiting 10 seconds before retry..."
                sleep 10
              else
                echo "‚ùå All attempts failed - class loading unsuccessful"
                exit 1
              fi
            fi
          done
          
      - name: Enhanced class loading diagnostics
        run: |
          echo "=== Enhanced Class Loading Diagnostics ==="
          
          # Check if app is in both locations
          echo "Checking app locations..."
          docker exec nextcloud-test bash -c "echo 'Apps-extra location:'; ls -la /var/www/html/apps-extra/ | grep openconnector || echo 'Not found in apps-extra'"
          docker exec nextcloud-test bash -c "echo 'Apps location:'; ls -la /var/www/html/apps/ | grep openconnector || echo 'Not found in apps'"
          
          # Check if vendor directory exists in new location
          echo "Checking vendor directory in new location..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/apps/openconnector/vendor/ 2>/dev/null || echo 'No vendor directory in new location'"
          
          # Check if app is properly registered with Nextcloud
          echo "Checking if app is registered with Nextcloud..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php occ app:list | grep openconnector || echo 'App not found in Nextcloud app list'"
          
          # Check app info and namespace
          echo "Checking app info and namespace..."
          docker exec nextcloud-test bash -c "cat /var/www/html/apps/openconnector/appinfo/info.xml | grep -E '(id|name)'"
          
          # Try to find the Application class file
          echo "Looking for Application class file..."
          docker exec nextcloud-test bash -c "find /var/www/html/apps/openconnector -name 'Application.php' -type f"
          
          # Check if autoloader is working
          echo "Testing autoloader..."
          docker exec nextcloud-test bash -c "cd /var/www/html && php -r 'echo \"Autoloader test...\n\"; if (class_exists(\"OCA\\\\OpenConnector\\\\AppInfo\\\\Application\")) { echo \"‚úÖ OpenConnector Application class found (SUCCESS!)\n\"; } else { echo \"‚ùå OpenConnector Application class not found (this indicates a problem)\n\"; }'"
          
      - name: Diagnose Nextcloud container environment
        run: |
          echo "=== Nextcloud Container Environment Diagnostics ==="
          echo "Checking if composer is available..."
          if ! docker exec nextcloud-test bash -c "which composer"; then
            echo "‚ùå ERROR: Composer is not available in the container"
            exit 1
          fi
          echo "‚úÖ Composer is available"
          
          echo "Checking if php is available..."
          if ! docker exec nextcloud-test bash -c "which php"; then
            echo "‚ùå ERROR: PHP is not available in the container"
            exit 1
          fi
          echo "‚úÖ PHP is available"
          
          echo "Checking if composer.phar exists..."
          if ! docker exec nextcloud-test bash -c "ls -la /var/www/html/composer.phar"; then
            echo "‚ö†Ô∏è  WARNING: composer.phar not found, but this may be normal"
          else
            echo "‚úÖ composer.phar found"
          fi
          
          echo "Checking vendor directory..."
          if ! docker exec nextcloud-test bash -c "ls -la /var/www/html/vendor/"; then
            echo "‚ö†Ô∏è  WARNING: vendor directory not found, but this may be normal"
          else
            echo "‚úÖ vendor directory found"
          fi
          echo "=== End Environment Diagnostics ==="
          
      - name: Install PHPUnit in Nextcloud container
        run: |
          echo "=== PHPUnit Installation ==="
          echo "Attempting to install PHPUnit in Nextcloud container..."
          
          # Install PHPUnit with standard installation
          if ! docker exec nextcloud-test bash -c "cd /var/www/html && composer require --dev phpunit/phpunit:^9.6"; then
            echo "‚ùå ERROR: Failed to install PHPUnit in Nextcloud container"
            echo "This may be due to composer not being available or network issues"
            exit 1
          fi
          echo "‚úÖ PHPUnit installed successfully"
          
          # Regenerate autoloader to fix class loading issues
          echo "Regenerating autoloader to fix class loading..."
          # Composer dump-autoload is synchronous but regenerates class maps
          docker exec nextcloud-test bash -c "cd /var/www/html && composer dump-autoload --optimize"
          
          # Check if phpunit executable exists
          echo "Checking PHPUnit executable location..."
          docker exec nextcloud-test bash -c "cd /var/www/html && find . -name phpunit -type f"
          
          echo "Verifying PHPUnit installation..."
          if ! docker exec nextcloud-test bash -c "cd /var/www/html && ./lib/composer/bin/phpunit --version"; then
            echo "‚ùå ERROR: PHPUnit installation verification failed"
            echo "Checking alternative locations..."
            docker exec nextcloud-test bash -c "cd /var/www/html && find . -name phpunit -type f -executable"
            echo "Trying to run PHPUnit with full path..."
            docker exec nextcloud-test bash -c "cd /var/www/html && php ./lib/composer/bin/phpunit --version"
            exit 1
          fi
          echo "‚úÖ PHPUnit is working correctly"
          
      - name: Diagnose PHPUnit installation issues
        run: |
          echo "=== PHPUnit Installation Diagnostics ==="
          echo "Checking if vendor directory exists..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/vendor/ || echo 'vendor directory not found'"
          
          echo "Checking if vendor/bin directory exists..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/vendor/bin/ || echo 'vendor/bin directory not found'"
          
          echo "Checking what's in vendor/bin directory..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/vendor/bin/ | head -20 || echo 'Cannot list vendor/bin contents'"
          
          echo "Checking if phpunit executable exists..."
          docker exec nextcloud-test bash -c "ls -la /var/www/html/vendor/bin/phpunit || echo 'phpunit executable not found'"
          
          echo "Checking composer.json for phpunit dependency..."
          docker exec nextcloud-test bash -c "grep -i phpunit /var/www/html/composer.json || echo 'phpunit not found in composer.json'"
          
          echo "Checking composer.lock for phpunit..."
          docker exec nextcloud-test bash -c "grep -i phpunit /var/www/html/composer.lock || echo 'phpunit not found in composer.lock'"
          
          echo "Checking if we can run composer show phpunit..."
          docker exec nextcloud-test bash -c "cd /var/www/html && composer show phpunit/phpunit || echo 'phpunit not installed via composer'"
          
          echo "Checking current working directory in container..."
          docker exec nextcloud-test bash -c "pwd && ls -la"
          
          echo "Checking if we can find phpunit anywhere..."
          docker exec nextcloud-test bash -c "find /var/www/html -name phpunit -type f 2>/dev/null || echo 'phpunit not found anywhere'"
          
          echo "=== End PHPUnit Diagnostics ==="
          
      - name: Run PHP linting on GitHub Actions runner
        run: composer lint
        continue-on-error: true
        
      - name: Run unit tests inside Nextcloud container
        run: |
          # Run tests from inside the Nextcloud container where all OCP classes are available
          echo "Running tests inside Nextcloud container..."
          docker exec nextcloud-test bash -c "cd /var/www/html && ./lib/composer/bin/phpunit --bootstrap apps-extra/openconnector/tests/bootstrap.php apps-extra/openconnector/tests"
        
      - name: Upload coverage (PHP 8.2 only)
        if: matrix.php-version == '8.2'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: Cleanup containers
        if: always()
        run: |
          docker stop nextcloud-test mariadb-test redis-test mail-test || true
          docker rm nextcloud-test mariadb-test redis-test mail-test || true

  quality:
    name: Code Quality & Standards with Nextcloud
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Load version configuration
        run: |
          echo "Loading centralized version configuration..."
          if [ -f .github/workflows/versions.env ]; then
            echo "‚úÖ Found versions.env file"
            cat .github/workflows/versions.env
            # Export variables for use in subsequent steps
            echo "NEXTCLOUD_VERSION=31" >> $GITHUB_ENV
            echo "MARIADB_VERSION=10.6" >> $GITHUB_ENV
            echo "REDIS_VERSION=7" >> $GITHUB_ENV
            echo "MAILHOG_VERSION=latest" >> $GITHUB_ENV
            echo "NEXTCLOUD_IMAGE=nextcloud:31" >> $GITHUB_ENV
            echo "MARIADB_IMAGE=mariadb:10.6" >> $GITHUB_ENV
            echo "REDIS_IMAGE=redis:7" >> $GITHUB_ENV
            echo "MAILHOG_IMAGE=ghcr.io/juliusknorr/nextcloud-dev-mailhog:latest" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No versions.env found, using defaults"
            echo "NEXTCLOUD_VERSION=31" >> $GITHUB_ENV
            echo "MARIADB_VERSION=10.6" >> $GITHUB_ENV
            echo "REDIS_VERSION=7" >> $GITHUB_ENV
            echo "MAILHOG_VERSION=latest" >> $GITHUB_ENV
            echo "NEXTCLOUD_IMAGE=nextcloud:31" >> $GITHUB_ENV
            echo "MARIADB_IMAGE=mariadb:10.6" >> $GITHUB_ENV
            echo "REDIS_IMAGE=redis:7" >> $GITHUB_ENV
            echo "MAILHOG_IMAGE=ghcr.io/juliusknorr/nextcloud-dev-mailhog:latest" >> $GITHUB_ENV
          fi
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, pdo, zip, curl, mysql
          tools: composer:v2
          
      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
        
      - name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
        
      - name: Start MariaDB, Redis, Mail and Nextcloud with Docker
        run: |
          # Start MariaDB container (matching local setup)
          docker run -d \
            --name mariadb-test-quality \
            -e MYSQL_ROOT_PASSWORD=nextcloud \
            -e MYSQL_PASSWORD=nextcloud \
            -e MYSQL_USER=nextcloud \
            -e MYSQL_DATABASE=nextcloud \
            ${{ env.MARIADB_IMAGE }}
          
          # Start Redis container (required by Nextcloud)
          docker run -d \
            --name redis-test-quality \
            ${{ env.REDIS_IMAGE }}
          
          # Start Mail container (MailHog for testing) - matching local setup
          docker run -d \
            --name mail-test-quality \
            -p 1026:1025 \
            -p 8026:8025 \
            ${{ env.MAILHOG_IMAGE }}
          
          # Wait for MariaDB to be ready
          echo "Waiting for MariaDB to start..."
          timeout 60 bash -c 'until docker exec mariadb-test-quality mysqladmin ping -h"localhost" --silent; do sleep 2; done'
          
          # Start Nextcloud container with all dependencies - matching local setup
          docker run -d \
            --name nextcloud-test-quality \
            --link mariadb-test-quality:db \
            --link redis-test-quality:redis \
            --link mail-test-quality:mail \
            -p 8081:80 \
            -e MYSQL_HOST=db \
            -e MYSQL_DATABASE=nextcloud \
            -e MYSQL_USER=nextcloud \
            -e MYSQL_PASSWORD=nextcloud \
            -e REDIS_HOST=redis \
            -e REDIS_PORT=6379 \
            -e MAIL_SMTP_HOST=mail \
            -e MAIL_SMTP_PORT=1025 \
            -e MAIL_SMTP_NAME=mail \
            -e MAIL_SMTP_PASSWORD= \
            -e MAIL_SMTP_SECURE= \
            -e MAIL_FROM_ADDRESS=nextcloud@localhost \
            -e MAIL_DOMAIN=localhost \
            -e NEXTCLOUD_ADMIN_USER=admin \
            -e NEXTCLOUD_ADMIN_PASSWORD=admin \
            -e NEXTCLOUD_TRUSTED_DOMAINS=localhost \
            -e WITH_REDIS=YES \
            ${{ env.NEXTCLOUD_IMAGE }}
          
          # Wait for Nextcloud to be fully ready (including database initialization)
          echo "Waiting for Nextcloud to be fully initialized..."
          timeout 600 bash -c 'until curl -sSf http://localhost:8081/status.php | grep -q "installed.*true"; do echo "Waiting for Nextcloud to start..."; sleep 10; done'
          echo "Nextcloud is fully initialized and ready!"
          
          # Create apps-extra directory in Nextcloud container
          echo "Creating apps-extra directory in Nextcloud container..."
          docker exec nextcloud-test-quality mkdir -p /var/www/html/apps-extra
          
          # Copy the OpenConnector app into the container
          echo "Copying OpenConnector app into Nextcloud container..."
          docker cp . nextcloud-test-quality:/var/www/html/apps-extra/openconnector
          
          # Wait a bit more for Nextcloud to fully process the app installation
          echo "Waiting for app installation to complete..."
          sleep 10
          
      - name: Install Composer in Nextcloud container (Quality)
        run: |
          echo "=== Installing Composer in Nextcloud Container (Quality) ==="
          echo "Installing Composer..."
          docker exec nextcloud-test-quality bash -c "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
          echo "Verifying Composer installation..."
          if ! docker exec nextcloud-test-quality bash -c "composer --version"; then
            echo "‚ùå ERROR: Composer installation failed"
            exit 1
          fi
          echo "‚úÖ Composer installed successfully"
          
      - name: Install development dependencies in Nextcloud container
        run: |
          echo "Installing development dependencies in Nextcloud container..."
          
          # Install development tools in the container (Composer already installed)
          echo "Installing php-cs-fixer in Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && composer require --dev friendsofphp/php-cs-fixer:^3.0 --no-interaction"
          
          echo "Installing psalm in Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && composer require --dev vimeo/psalm:^5.0 --no-interaction"
          
          echo "‚úÖ Development dependencies installed in Nextcloud container"
          
      - name: Diagnose Nextcloud occ command availability (Quality)
        run: |
          echo "=== Nextcloud occ Command Diagnostics (Quality) ==="
          echo "Checking if occ command is available..."
          
          # Check if occ file exists
          if ! docker exec nextcloud-test-quality bash -c "test -f /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file not found at /var/www/html/occ"
            echo "This indicates Nextcloud is not properly installed"
            exit 1
          fi
          echo "‚úÖ occ file exists at /var/www/html/occ"
          
          # Check if occ is executable
          if ! docker exec nextcloud-test-quality bash -c "test -x /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file is not executable"
            echo "This indicates Nextcloud installation is incomplete"
            exit 1
          fi
          echo "‚úÖ occ file is executable"
          
          # Test if occ command works (with timeout and better error handling)
          echo "Testing occ command with timeout..."
          if timeout 30 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ --version" 2>/dev/null; then
            echo "‚úÖ occ command is working"
          else
            echo "‚ö†Ô∏è  WARNING: occ command test failed or timed out"
            echo "This might indicate Nextcloud is still initializing, but we'll continue..."
            echo "Checking if we can proceed anyway..."
            
            # Try a simpler test
            if docker exec nextcloud-test-quality bash -c "cd /var/www/html && php -r 'echo \"PHP working\n\";'" 2>/dev/null; then
              echo "‚úÖ PHP is working, continuing with app installation..."
            else
              echo "‚ùå ERROR: PHP is not working in the container"
            exit 1
          fi
          fi
          
          echo "Checking Nextcloud installation..."
          if ! docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/occ"; then
            echo "‚ùå ERROR: occ file not found at /var/www/html/occ"
            echo "This indicates Nextcloud is not properly installed"
            exit 1
          fi
          echo "‚úÖ occ file found"
          
          echo "Checking if Nextcloud is fully initialized..."
          if ! docker exec nextcloud-test-quality bash -c "php -r 'echo \"PHP is working\n\";'"; then
            echo "‚ùå ERROR: PHP is not working in the container"
            exit 1
          fi
          echo "‚úÖ PHP is working"
          echo "=== End occ Command Diagnostics (Quality) ==="
          
      - name: Install and enable OpenConnector app (Quality)
        run: |
          echo "=== OpenConnector App Installation (Quality) ==="
          echo "Checking Nextcloud version compatibility..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ --version"
          
          # Check if app directory exists
          echo "Checking if OpenConnector app directory exists..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps-extra/openconnector/"
          
          # List available apps
          echo "Listing available apps..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list"
          
          # Move app to correct location for Nextcloud
          echo "Moving app to correct location for Nextcloud..."
          docker exec nextcloud-test-quality bash -c "cp -r /var/www/html/apps-extra/openconnector /var/www/html/apps/"
          echo "App moved to /var/www/html/apps/openconnector"
          
          # Install app dependencies BEFORE enabling the app
          echo "Installing app dependencies before enabling..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html/apps/openconnector && composer install --no-dev --optimize-autoloader --ignore-platform-req=ext-soap --ignore-platform-req=ext-xsl"
          echo "‚úÖ App dependencies installed successfully"
          
          # Run maintenance:repair to ensure database schema is ready
          echo "Running maintenance:repair to prepare database schema..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Database schema prepared"
          
          # Test available Nextcloud commands for database preparation (v1.35)
          echo "=== Testing Available Nextcloud Commands ==="
          echo "üîç DIAGNOSTIC: Testing app --help command with enhanced diagnostics..."
          
          # Wait for Nextcloud to be fully ready
          echo "üîÑ Waiting for Nextcloud to be fully ready..."
          sleep 15
          
          # Check if Nextcloud is responding to basic commands first
          echo "üîÑ Testing basic Nextcloud functionality..."
          if ! timeout 30 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ --version"; then
            echo "‚ùå ERROR: Nextcloud basic commands not working"
            echo "Checking container status..."
            docker exec nextcloud-test-quality bash -c "ps aux | grep php"
            echo "Checking Nextcloud logs..."
            docker exec nextcloud-test-quality bash -c "tail -20 /var/www/html/data/nextcloud.log"
            exit 1
          fi
          echo "‚úÖ Nextcloud basic commands working"
          
          # Check what app commands are available (with timeout)
          echo "üîÑ Checking available app commands..."
          if timeout 30 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app --help" 2>/dev/null; then
            echo "‚úÖ App commands are working"
          else
            echo "‚ö†Ô∏è  WARNING: app --help command failed or timed out"
            echo "Trying alternative approach..."
            echo "üîÑ Checking app commands with verbose output..."
            if timeout 30 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list" 2>/dev/null; then
              echo "‚úÖ app:list is working, continuing..."
            else
              echo "‚ö†Ô∏è  app:list also failed, trying basic occ list..."
              if timeout 30 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ list" 2>/dev/null; then
                echo "‚úÖ Basic occ commands are working, continuing..."
              else
                echo "‚ùå All occ commands are failing - this indicates a serious Nextcloud issue"
                exit 1
              fi
            fi
          fi
          
          # Try to install the app directly (this should trigger migrations)
          echo "üîÑ Testing: Direct app install (should trigger migrations)..."
          echo "üîç DIAGNOSTIC: Adding timeout to prevent hanging progress bar (v1.40)..."
          if timeout 180 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:install openconnector"; then
            echo "‚úÖ SUCCESS: App installed successfully with migrations"
            MIGRATION_SUCCESS=true
          else
            echo "‚ùå FAILED: Direct app install failed or timed out"
            echo "üîç DIAGNOSTIC: Checking if app is partially installed..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list | grep openconnector || echo 'App not found in list'"
            MIGRATION_SUCCESS=false
          fi
          
          # If direct install failed, try alternative approach
          if [ "$MIGRATION_SUCCESS" = false ]; then
            echo "üîÑ Fallback: Trying app:enable..."
            echo "üîç DIAGNOSTIC: Adding timeout to app:enable command (v1.40)..."
            if timeout 90 docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:enable openconnector"; then
              echo "‚úÖ SUCCESS: App enabled successfully"
              MIGRATION_SUCCESS=true
            else
              echo "‚ùå FAILED: App enable also failed or timed out"
              MIGRATION_SUCCESS=false
            fi
          fi
          
          # Final fallback: try app:update
          if [ "$MIGRATION_SUCCESS" = false ]; then
            echo "üîÑ Final fallback: Trying app:update..."
            if docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:update openconnector"; then
              echo "‚úÖ SUCCESS: App updated successfully"
              MIGRATION_SUCCESS=true
            else
              echo "‚ùå FAILED: App update also failed"
              MIGRATION_SUCCESS=false
            fi
          fi
          
          # Summary of results
          echo "=== Migration Test Results ==="
          echo "Migration preparation: $MIGRATION_SUCCESS"
          
          # Check if app is already enabled from migration testing
          if [ "$MIGRATION_SUCCESS" = true ]; then
            echo "‚úÖ App already enabled during migration testing"
          else
            echo "‚ùå ERROR: All migration approaches failed"
            echo "Checking app status..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list | grep openconnector"
            echo "Checking Nextcloud logs..."
            docker exec nextcloud-test-quality bash -c "tail -50 /var/www/html/data/nextcloud.log"
            echo "Checking if database table exists..."
            docker exec mariadb-test-quality bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES LIKE \"oc_openconnector_job_logs\";'"
            echo "Checking database connection..."
            docker exec mariadb-test-quality bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SELECT COUNT(*) FROM oc_openconnector_job_logs;'"
            exit 1
          fi
          echo "‚úÖ OpenConnector app enabled successfully"
          
          # Run database migrations for the app
          echo "Running database migrations for OpenConnector app..."
          echo "üîÑ Running db:add-missing-indices..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ db:add-missing-indices"
          echo "üîÑ Running db:add-missing-columns..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ db:add-missing-columns"
          echo "üîÑ Running db:convert-filecache-bigint..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ db:convert-filecache-bigint"
          
          # Force app migration execution by disabling and re-enabling the app
          echo "üîÑ Forcing app migration execution..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:disable openconnector"
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ Database migrations completed"
          
          # Verify the required table exists after migrations
          echo "üîÑ Verifying database table exists after migrations..."
          echo "üîç DIAGNOSTIC: Testing MariaDB connection from mariadb-test-quality container..."
          if docker exec mariadb-test-quality bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SELECT COUNT(*) FROM oc_openconnector_job_logs;'" 2>/dev/null; then
            echo "‚úÖ Table oc_openconnector_job_logs exists"
            echo "üéâ SUCCESS: Database verification with MariaDB container connection works!"
          else
            echo "‚ùå Table oc_openconnector_job_logs still doesn't exist after migrations"
            echo "üîç DIAGNOSTIC: Checking what tables actually exist..."
            docker exec mariadb-test-quality bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES LIKE \"oc_openconnector%\";'"
            echo "üîç DIAGNOSTIC: Checking all tables in nextcloud database..."
            docker exec mariadb-test-quality bash -c "mysql -u nextcloud -p'nextcloud' nextcloud -e 'SHOW TABLES;'" | grep -i openconnector || echo "No openconnector tables found"
            echo "This indicates the app's migration files are not being executed properly"
            exit 1
          fi
          
          # Verify app is properly enabled
          echo "Verifying app installation..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list | grep openconnector"
          
          # Set up test environment
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ config:system:set debug --value true"
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ config:system:set loglevel --value 0"
          
          # Wait a bit more for Nextcloud to fully process the app installation
          echo "Waiting for app installation to complete..."
          sleep 10
          
      - name: Verify app installation and run diagnostics (Quality)
        run: |
          echo "=== App Installation Verification and Diagnostics (Quality) ==="
          echo "Verifying app dependencies are present..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/vendor/autoload.php || echo 'Autoloader not found'"
          
          # Check app structure and files
          echo "Checking app structure and files..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps-extra/openconnector/"
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps-extra/openconnector/appinfo/"
          docker exec nextcloud-test-quality bash -c "cat /var/www/html/apps-extra/openconnector/appinfo/info.xml | head -10"
          
          # Check if app is in the right location for Nextcloud
          echo "Checking if app is in correct location..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/ 2>/dev/null | grep openconnector || echo 'No openconnector found in /var/www/html/apps/'"
          
          echo "‚úÖ App should already be in /var/www/html/apps/ from previous step"
          
          # Force Nextcloud to rescan apps and clear caches
          echo "Forcing Nextcloud to rescan apps and clear caches..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list"
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ maintenance:repair"
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list"
          
          # Check if app classes are available after dependencies
          echo "Checking if app classes are available (after dependencies)..."
          echo "üéØ This should now work after installing dependencies"
          
          # Pre-class loading diagnostics
          echo "=== Pre-Class Loading Diagnostics (Quality) ==="
          echo "Checking app installation status..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list | grep openconnector || echo 'App not found in Nextcloud app list'"
          
          echo "Checking app file structure..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/ || echo 'App directory not found'"
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/ || echo 'Lib directory not found'"
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/vendor/ || echo 'Vendor directory not found'"
          
          echo "Checking app info.xml..."
          docker exec nextcloud-test-quality bash -c "cat /var/www/html/apps/openconnector/appinfo/info.xml | head -10"
          
          echo "Checking if Application.php exists..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/AppInfo/Application.php || echo 'Application.php not found'"
          
          echo "Checking autoloader files..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/vendor/autoload.php || echo 'Vendor autoload.php not found'"
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php || echo 'App autoload.php not found'"
          
          # Check if autoloader was already generated during app installation
          echo "üîç DIAGNOSTIC: Checking if autoloader was generated during initial app installation..."
          if docker exec nextcloud-test-quality bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php already exists from app installation!"
            echo "‚úÖ No additional autoloader generation needed"
            exit 0
          else
            echo "‚ùå lib/autoload.php not found after app installation - proceeding with generation..."
          fi
          
          # v1.43: Comprehensive autoloader generation strategy
          echo "üîß ATTEMPTING: Comprehensive autoloader generation strategy (v1.43)..."
          
          # Step 1: Force app disable/enable cycle to trigger autoloader generation
          echo "üîÑ Step 1: Force app disable/enable cycle to trigger autoloader generation..."
          echo "üîç DIAGNOSTIC: Disabling app to force regeneration..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:disable openconnector" || echo "App disable failed or app not enabled"
          echo "üîç DIAGNOSTIC: Re-enabling app to trigger autoloader generation..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ App disable/enable cycle completed"
          
          # Step 2: Force maintenance repair to regenerate autoloaders
          echo "üîÑ Step 2: Force maintenance repair to regenerate autoloaders..."
          echo "üîç DIAGNOSTIC: Running maintenance:repair to regenerate autoloaders..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Maintenance repair completed"
          
          # Step 3: Force app update with --force flag
          echo "üîÑ Step 3: Force app update with --force flag..."
          echo "üîç DIAGNOSTIC: Running app:update with force flag..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:update openconnector --force" || echo "Force update not supported, trying regular update..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:update openconnector"
          echo "‚úÖ App update completed"
          
          # Step 4: Generate autoloader manually using Composer
          echo "üîÑ Step 4: Generate autoloader manually using Composer..."
          echo "üîç DIAGNOSTIC: Running composer dump-autoload with classmap optimization..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html/apps/openconnector && composer dump-autoload --optimize --classmap-authoritative"
          echo "‚úÖ Composer autoloader generation completed"
          
          # Step 5: Create lib/autoload.php manually if still missing
          echo "üîÑ Step 5: Create lib/autoload.php manually if still missing..."
          echo "üîç DIAGNOSTIC: Checking if lib/autoload.php exists after all attempts..."
          if docker exec nextcloud-test-quality bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php exists after comprehensive generation!"
          else
            echo "üîß ATTEMPTING: Creating lib/autoload.php manually..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html/apps/openconnector && cat > lib/autoload.php << 'EOF'
<?php
// Nextcloud app autoloader for OpenConnector
// Generated by v1.43 comprehensive autoloader generation

// Include Composer autoloader
require_once __DIR__ . '/../vendor/autoload.php';

// Register PSR-4 autoloader for OCA\\OpenConnector namespace
spl_autoload_register(function (\$class) {
    // Handle OCA\\OpenConnector namespace
    if (strpos(\$class, 'OCA\\\\OpenConnector\\\\') === 0) {
        \$class = substr(\$class, 19); // Remove 'OCA\\\\OpenConnector\\\\'
        \$file = __DIR__ . '/' . str_replace('\\\\', '/', \$class) . '.php';
        if (file_exists(\$file)) {
            require_once \$file;
        }
    }
});
EOF"
            echo "‚úÖ Manual lib/autoload.php created"
          fi

          # Final verification
          echo "üîç DIAGNOSTIC: Final verification of autoloader..."
          if docker exec nextcloud-test-quality bash -c "test -f /var/www/html/apps/openconnector/lib/autoload.php"; then
            echo "‚úÖ SUCCESS: lib/autoload.php verified after comprehensive generation!"
            echo "üîç DIAGNOSTIC: Checking autoloader file size and permissions..."
            docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php"
          else
            echo "‚ùå ERROR: lib/autoload.php still not found after comprehensive generation"
            echo "üîç DIAGNOSTIC: Checking what was generated in container..."
            docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/ || echo 'lib directory not found'"
            echo "üîç DIAGNOSTIC: Checking composer.json for autoload configuration..."
            docker exec nextcloud-test-quality bash -c "cat /var/www/html/apps/openconnector/composer.json | grep -A 10 -B 5 autoload || echo 'No autoload section found'"
            echo "üîç DIAGNOSTIC: Checking if lib directory exists..."
            docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/ | grep lib"
            echo "üîç DIAGNOSTIC: Checking where Composer actually placed autoload files..."
            docker exec nextcloud-test-quality bash -c "find /var/www/html/apps/openconnector -name 'autoload.php' -type f"
            echo "üîç DIAGNOSTIC: Checking vendor directory for autoload files..."
            docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/vendor/ | grep autoload"
            echo "üîç DIAGNOSTIC: Checking if Composer created any autoload files in lib directory..."
            docker exec nextcloud-test-quality bash -c "find /var/www/html/apps/openconnector/lib -name '*autoload*' -type f"
            echo "üîç DIAGNOSTIC: Checking Composer working directory and current location..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html/apps/openconnector && pwd && ls -la"
            exit 1
          fi
          
          # Restart Nextcloud to reload the new autoloader
          echo "Restarting Nextcloud to reload autoloader..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:disable openconnector"
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:enable openconnector"
          echo "‚úÖ Nextcloud restarted with new autoloader"
          
          # Verify autoloader was created and clear cache
          echo "Verifying autoloader creation..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/lib/autoload.php || echo 'Autoloader still missing'"
          echo "Clearing Nextcloud cache..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ maintenance:repair"
          echo "‚úÖ Cache cleared after autoloader generation"
          
          # Wait for Nextcloud background processes to complete
          # maintenance:repair triggers background jobs (cache clearing, database migrations, etc.)
          # These processes need time to complete before classes become available
          echo "Waiting for Nextcloud background processes to complete..."
          
          # Try class loading with retry mechanism
          echo "Testing class loading with retry mechanism..."
          for i in {1..5}; do
            echo "Attempt $i/5:"
            if docker exec nextcloud-test-quality bash -c "cd /var/www/html && php -r 'echo \"Testing class loading...\n\"; if (class_exists(\"OCA\\\\OpenConnector\\\\AppInfo\\\\Application\")) { echo \"‚úÖ OpenConnector Application class found (SUCCESS!)\n\"; exit(0); } else { echo \"‚ùå OpenConnector Application class not found (attempt $i)\n\"; exit(1); }'"; then
              echo "‚úÖ Class loading successful on attempt $i"
              break
            else
              if [ $i -lt 5 ]; then
                echo "‚ö†Ô∏è Attempt $i failed, waiting 10 seconds before retry..."
                sleep 10
              else
                echo "‚ùå All attempts failed - class loading unsuccessful"
                exit 1
              fi
            fi
          done
          
      - name: Enhanced class loading diagnostics (Quality)
        run: |
          echo "=== Enhanced Class Loading Diagnostics (Quality) ==="
          
          # Check if app is in both locations
          echo "Checking app locations..."
          docker exec nextcloud-test-quality bash -c "echo 'Apps-extra location:'; ls -la /var/www/html/apps-extra/ | grep openconnector || echo 'Not found in apps-extra'"
          docker exec nextcloud-test-quality bash -c "echo 'Apps location:'; ls -la /var/www/html/apps/ | grep openconnector || echo 'Not found in apps'"
          
          # Check if vendor directory exists in new location
          echo "Checking vendor directory in new location..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/apps/openconnector/vendor/ 2>/dev/null || echo 'No vendor directory in new location'"
          
          # Check if app is properly registered with Nextcloud
          echo "Checking if app is registered with Nextcloud..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php occ app:list | grep openconnector || echo 'App not found in Nextcloud app list'"
          
          # Check app info and namespace
          echo "Checking app info and namespace..."
          docker exec nextcloud-test-quality bash -c "cat /var/www/html/apps/openconnector/appinfo/info.xml | grep -E '(id|name)'"
          
          # Try to find the Application class file
          echo "Looking for Application class file..."
          docker exec nextcloud-test-quality bash -c "find /var/www/html/apps/openconnector -name 'Application.php' -type f"
          
          # Check if autoloader is working
          echo "Testing autoloader..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && php -r 'echo \"Autoloader test...\n\"; if (class_exists(\"OCA\\\\OpenConnector\\\\AppInfo\\\\Application\")) { echo \"‚úÖ OpenConnector Application class found (SUCCESS!)\n\"; } else { echo \"‚ùå OpenConnector Application class not found (this indicates a problem)\n\"; }'"
          
      - name: Diagnose Nextcloud container environment (Quality)
        run: |
          echo "=== Nextcloud Container Environment Diagnostics (Quality) ==="
          echo "Checking if composer is available..."
          if ! docker exec nextcloud-test-quality bash -c "which composer"; then
            echo "‚ùå ERROR: Composer is not available in the container"
            exit 1
          fi
          echo "‚úÖ Composer is available"
          
          echo "Checking if php is available..."
          if ! docker exec nextcloud-test-quality bash -c "which php"; then
            echo "‚ùå ERROR: PHP is not available in the container"
            exit 1
          fi
          echo "‚úÖ PHP is available"
          
          echo "Checking if composer.phar exists..."
          if ! docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/composer.phar"; then
            echo "‚ö†Ô∏è  WARNING: composer.phar not found, but this may be normal"
          else
            echo "‚úÖ composer.phar found"
          fi
          
          echo "Checking vendor directory..."
          if ! docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/vendor/"; then
            echo "‚ö†Ô∏è  WARNING: vendor directory not found, but this may be normal"
          else
            echo "‚úÖ vendor directory found"
          fi
          echo "=== End Environment Diagnostics (Quality) ==="
          
      - name: Install PHPUnit in Nextcloud container (Quality)
        run: |
          echo "=== PHPUnit Installation (Quality) ==="
          echo "Attempting to install PHPUnit in Nextcloud container..."
          
          # Install PHPUnit with standard installation
          if ! docker exec nextcloud-test-quality bash -c "cd /var/www/html && composer require --dev phpunit/phpunit:^9.6"; then
            echo "‚ùå ERROR: Failed to install PHPUnit in Nextcloud container"
            echo "This may be due to composer not being available or network issues"
            exit 1
          fi
          echo "‚úÖ PHPUnit installed successfully"
          
          # Regenerate autoloader to fix class loading issues
          echo "Regenerating autoloader to fix class loading..."
          # Composer dump-autoload is synchronous but regenerates class maps
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && composer dump-autoload --optimize"
          
          # Check if phpunit executable exists
          echo "Checking PHPUnit executable location..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && find . -name phpunit -type f"
          
          echo "Verifying PHPUnit installation..."
          if ! docker exec nextcloud-test-quality bash -c "cd /var/www/html && ./lib/composer/bin/phpunit --version"; then
            echo "‚ùå ERROR: PHPUnit installation verification failed"
            echo "Checking alternative locations..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html && find . -name phpunit -type f -executable"
            echo "Trying to run PHPUnit with full path..."
            docker exec nextcloud-test-quality bash -c "cd /var/www/html && php ./lib/composer/bin/phpunit --version"
            exit 1
          fi
          echo "‚úÖ PHPUnit is working correctly"
          
      - name: Diagnose PHPUnit installation issues (Quality)
        run: |
          echo "=== PHPUnit Installation Diagnostics (Quality) ==="
          echo "Checking if vendor directory exists..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/vendor/ || echo 'vendor directory not found'"
          
          echo "Checking if vendor/bin directory exists..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/vendor/bin/ || echo 'vendor/bin directory not found'"
          
          echo "Checking what's in vendor/bin directory..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/vendor/bin/ | head -20 || echo 'Cannot list vendor/bin contents'"
          
          echo "Checking if phpunit executable exists..."
          docker exec nextcloud-test-quality bash -c "ls -la /var/www/html/vendor/bin/phpunit || echo 'phpunit executable not found'"
          
          echo "Checking composer.json for phpunit dependency..."
          docker exec nextcloud-test-quality bash -c "grep -i phpunit /var/www/html/composer.json || echo 'phpunit not found in composer.json'"
          
          echo "Checking composer.lock for phpunit..."
          docker exec nextcloud-test-quality bash -c "grep -i phpunit /var/www/html/composer.lock || echo 'phpunit not found in composer.lock'"
          
          echo "Checking if we can run composer show phpunit..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && composer show phpunit/phpunit || echo 'phpunit not installed via composer'"
          
          echo "Checking current working directory in container..."
          docker exec nextcloud-test-quality bash -c "pwd && ls -la"
          
          echo "Checking if we can find phpunit anywhere..."
          docker exec nextcloud-test-quality bash -c "find /var/www/html -name phpunit -type f 2>/dev/null || echo 'phpunit not found anywhere'"
          
          echo "=== End PHPUnit Diagnostics (Quality) ==="
          
      - name: Run PHP linting in Nextcloud container
        run: |
          echo "Running PHP linting in Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && find . -name '*.php' -exec php -l {} \;"
        continue-on-error: true
        
      - name: Run PHP CodeSniffer in Nextcloud container
        run: |
          echo "Running PHP CodeSniffer in Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && ./vendor/bin/php-cs-fixer fix --dry-run --diff"
        continue-on-error: true
        
      - name: Run Psalm static analysis in Nextcloud container
        run: |
          echo "Running Psalm static analysis in Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && ./vendor/bin/psalm --threads=1 --no-cache"
        continue-on-error: true
        
      - name: Run unit tests inside Nextcloud container (Quality)
        run: |
          # Run tests from inside the Nextcloud container where all OCP classes are available
          echo "Running tests inside Nextcloud container..."
          docker exec nextcloud-test-quality bash -c "cd /var/www/html && ./lib/composer/bin/phpunit --bootstrap apps-extra/openconnector/tests/bootstrap.php apps-extra/openconnector/tests"
        
      - name: Generate quality status
        if: always()
        run: |
          echo "## üîç Code Quality & Standards" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- ‚úÖ PHP Linting: Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Code Style: Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Static Analysis: Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Unit Tests: Completed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ All quality checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ùå PHP Linting: Failed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Code Style: Failed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Static Analysis: Failed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Some quality checks failed!" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Cleanup containers
        if: always()
        run: |
          docker stop nextcloud-test-quality mariadb-test-quality redis-test-quality mail-test-quality || true
          docker rm nextcloud-test-quality mariadb-test-quality redis-test-quality mail-test-quality || true
